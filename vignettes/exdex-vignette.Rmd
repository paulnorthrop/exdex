---
title: "Introducing exdex: Estimation of the Extremal Index"
author: "Paul Northrop"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Introducing exdex: Estimation of the Extremal Index}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: exdex.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
```

The extremal value index $\theta$ is a measure of the extent of clustering in the extremes of a stationary process, representing the reciprocal of the mean cluster size.  The main purpose of the *exdex* package is to implement the semiparametric maxima estimators developed in @Northrop2015 and @BB2018.  A feature of these works is the use of sliding block maxima, that is, the use of *all* blocks of consecutive values, rather than maxima over disjoint block of values.  This improves efficiency of estimation, albeit at the cost of complicating theoretical work.  Also provided are functions to estimate $\theta$ using two threshold-based methods: the iterated weighted least squares estimator (@Suveges2007) and the $K$-gaps estimator (@SD2010).

## Semiparametric maxima estimators

These estimators are based on the approximate relation $G(u_b) = F(u_b)^{b\theta}$ between the marginal distribution function $F$ of the process and the distribution function $G$ of the block maximum $M$ of $b$ consecutive variables, which applies provided that $b$ and $u_b$ are large. If $G = F^{b\theta}$ then $Y = -b\log F(M)$ has an exponential($\theta$) distribution and $Z = b(1 - F(M))$ is a multiple $b$ of a beta($1, b\theta$) distribution.  

Let $(M_1, \ldots, M_k)$ be a sample of block maxima of $b$ consecutive values.  The marginal distribution function $F$ is not known so we estimate it using the empirical distribution function $\hat{F}$ set
\[ \quad Y_i = -b \log \hat{F}(M_i), \quad Z_i = b(1 - \hat{F}(M_i)), \quad i = 1, \ldots, k \]
and define the estimators
\[ \hat{\theta}_N = \left( \frac{1}{k} \sum_{i=1}^k Y_i \right)^{-1} \quad 
\hat{\theta}_{BB} = \left( \frac{1}{k} \sum_{i=1}^k Z_i \right)^{-1}. \]
These two estimators are equivalent asymptotically.
The former is the estimator proposed in @Northrop2015. @BB2018 derived asymptotic properties of the latter, because it is more amenable to mathematical analysis.

The function `spm` provides three estimators, estimated using both sliding and disjoint block maxima and four types of bias-adjustment.  The estimators are $\hat{\theta}_N, \hat{\theta}_{BB}$ and $\hat{\theta}_{BB}-1/b$. The latter is motivated by the observation that E$(Z)  = (\theta + 1/b)^{-1} < \theta^{-1}$ and therefore the subtraction of $1 / b$ provides further bias-adjustment.  In fact empirical results indicate that $\hat{\theta}_N$ and $\hat{\theta}_{BB} - 1/b$ produce similar estimates.

### Newlyn sea surges

We provide an illustration of the `spm` function using the `newlyn` data, a time series of 2894 maximum seas surges measured at Newlyn, Cornwall, UK over the period 1971-1976.  We use a block size $b = 20$.  We explain in a moment how this value was chosen.

```{r}
library(exdex)
theta <- spm(newlyn, 20)
# Estimates: BB2018b is BB2018 - 1/b
theta
# Estimates, SEs and bias-adjustments
summary(theta)
```

There is a `confint` method for calculating confidence intervals using objects returned from `spm`.  The likelihood-based intervals are based on an adjustment (performed by the `chandwich` package @chandwich) of the naive (pseudo-)loglikelihood so that the curvature of the adjusted loglikelihood agrees with the estimated standard errors.

```{r, fig.width=7, fig.height= 6}
# Sliding maxima, symmetric intervals
conf <- confint(theta)
# Sliding maxima, likelihood-based intervals
conf <- confint(theta, interval_type = "lik")
plot(conf)
```

### Block size selection

An informal way to choose the value of $b$ is plots estimates of $\theta$ over a range of values of $b$ and to select the smallest $b$ above which these estimates appear to be constant with respect to $b$, taking into account sampling variability.  The function `choose_b`, and its associated plot method, does this, quantifying sampling variablity using pointwise confidence intervals.  The plot method allows us to select one of 3 estimators and choose whether to use sliding or disjoint block maxima.  The default is to plot the estimates using the @Northrop2015 estimator applied to sliding maxima.

```{r, fig.width=7, fig.height= 6}
# Plot like the top left of Northrop (2015)
# We remove the 14 values because 2880 has lots of factors
b_vals <- c(2,3,4,5,6,8,9,10,12,15,16,18,20,24,30,32,36,40,45,48,54,60)
res <- choose_b(newlyn[1:2880], b_vals)
# Some b are too small for the sampling variance of the sliding blocks
# estimator to be estimated
plot(res, ylim = c(0, 1))
```

This plots suggests that $b = 20$ is a reasonable block size to choose.  Indeed the point estimates varies smoothly with $b$ and varies little for $b \geq 20$. The confidence intervals tend to widen as $b$ increases, although the method for estimating these intervals is somewhat sensitive to block size owing to its use of disjoint block maxima. See the help file for `spm` and @BB2018 for further information. Note that for very small values of $b$ it may not be possible to estimate the confidence intervals, hence the missing intervals in this plot.

## Threshold-based estimators

### $K$-gaps

```{r}
u <- quantile(newlyn, probs = 0.90)
theta <- kgaps(newlyn, u)
theta
summary(theta)
```

### Iterated weighted least squares

The current implementation of this estimator is very limited: only an estimate is produced, with no estimates of uncertainty.  The next release of *exdex* wil rectify this.


```{r}
u <- quantile(newlyn, probs = 0.90)
theta <- iwls(newlyn, u)
theta
```

## References

<script type="text/x-mathjax-config">
   MathJax.Hub.Config({  "HTML-CSS": { minScaleAdjust: 125, availableFonts: [] }  });
</script>

